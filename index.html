<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒã‚¹å…¨åŠ›å€¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Ver.5.0</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 14px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #6f42c1;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 10px;
        }
        .input-grid { display: grid; gap: 14px; }
        .input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 12px;
        }
        .input-label { font-weight: 500; color: #555; }
        .input-label-hint {
            font-size: 0.85em;
            color: #999;
            font-weight: normal;
            display: block;
            margin-top: 2px;
        }
        input[type="number"], select {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #6f42c1;
        }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .card-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .card-section-title {
            font-weight: 600;
            color: #6f42c1;
            margin-bottom: 12px;
            font-size: 1.05rem;
        }
        .card-config { display: grid; gap: 16px; }
        .card-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .card-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .card-item-header label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }
        .card-detail-grid { display: grid; gap: 8px; margin-top: 8px; }
        .card-detail-row {
            display: grid;
            grid-template-columns: 100px 80px 120px;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .card-detail-label { color: #666; }
        .card-detail-input { width: 70px !important; }
        .timing-select { width: 110px !important; font-size: 12px; }
        .usage-timing-row {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        .radio-group { display: flex; gap: 12px; }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .radio-label input[type="radio"] { width: auto; }
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 16px;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn:active { transform: translateY(0); }
        .error-message {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
            white-space: pre-line;
        }
        .error-message.show { display: block; }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 12px;
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        th {
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            font-size: 11px;
        }
        td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        tbody tr:hover { background: #f8f9ff; }
        tbody tr:last-child td { border-bottom: none; }
        .col-turn { font-weight: 600; color: #6f42c1; }
        .col-risky { font-size: 16px; }
        .col-trend { color: #dc3545; font-weight: 600; }
        .col-stamina-start {
            background: #fff8e1;
            font-weight: bold;
            color: #f57c00;
        }
        .col-stamina-after-chai {
            background: #e8f5e9;
            color: #388e3c;
        }
        .col-stamina-end {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        .col-next-turn-effect { color: #7b1fa2; font-size: 11px; }
        .warning-row { background: #fff3cd !important; }
        .danger-row { background: #f8d7da !important; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 11px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }
        @media (max-width: 768px) {
            .card-detail-row { grid-template-columns: 1fr; }
            table { font-size: 10px; }
            th, td { padding: 6px 3px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <span>âš™ï¸</span>
                <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</span>
            </div>
            <div class="error-message" id="errorMessage"></div>
            <form id="simulatorForm" class="input-grid">
                <div class="input-row">
                    <label class="input-label" for="targetStamina">
                        æœ€çµ‚ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®å…¨åŠ›å€¤
                        <span class="input-label-hint">å¸Œæœ›ã™ã‚‹æ®‹1ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®å€¤</span>
                    </label>
                    <input type="number" id="targetStamina" name="targetStamina" min="0" max="200" value="0" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="currentTurn">ç¾åœ¨æ®‹ã‚¿ãƒ¼ãƒ³æ•°</label>
                    <input type="number" id="currentTurn" name="currentTurn" min="1" max="20" value="6" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="currentTrendLevel">
                        ç¾åœ¨ã®ãƒˆãƒ¬ãƒªå€¤
                        <span class="input-label-hint">ç¾åœ¨ã®æ¶ˆè²»å€¤</span>
                    </label>
                    <input type="number" id="currentTrendLevel" name="currentTrendLevel" min="0" max="20" value="1" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="maxTrendLevel">
                        ãƒˆãƒ¬ãƒªæœ€å¤§å€¤
                        <span class="input-label-hint">æ¶ˆè²»å€¤ã®ä¸Šé™</span>
                    </label>
                    <input type="number" id="maxTrendLevel" name="maxTrendLevel" min="1" max="20" value="5" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="riskyStartTurn">
                        ãƒªã‚¹ã‚­ãƒ¼é–‹å§‹ã‚¿ãƒ¼ãƒ³
                        <span class="input-label-hint">æ®‹ã‚¿ãƒ¼ãƒ³æ•°ã§æŒ‡å®š</span>
                    </label>
                    <input type="number" id="riskyStartTurn" name="riskyStartTurn" min="0" max="20" value="4" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="riskyRemainingTurns">
                        ãƒªã‚¹ã‚­ãƒ¼æ®‹ã‚¿ãƒ¼ãƒ³æ•°
                        <span class="input-label-hint">ã‚ã¨ä½•ã‚¿ãƒ¼ãƒ³ç¶šãã‹</span>
                    </label>
                    <input type="number" id="riskyRemainingTurns" name="riskyRemainingTurns" min="0" max="20" value="4" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="hasMotivation">ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</label>
                    <select id="hasMotivation" name="hasMotivation" required>
                        <option value="0">ãªã—</option>
                        <option value="1">ã‚ã‚Š</option>
                    </select>
                </div>
                <div class="input-row">
                    <label class="input-label" for="chaiCount">ãƒãƒ£ã‚¤æœ¬æ•°</label>
                    <input type="number" id="chaiCount" name="chaiCount" min="0" max="10" value="1" required>
                </div>
                <div class="input-row">
                    <label class="input-label" for="trendStartTurn">
                        ãƒˆãƒ¬ãƒªé–‹å§‹ã‚¿ãƒ¼ãƒ³
                        <span class="input-label-hint">æ®‹ã‚¿ãƒ¼ãƒ³æ•°</span>
                    </label>
                    <input type="number" id="trendStartTurn" name="trendStartTurn" min="1" max="20" value="6" required>
                </div>

```
            <div class="card-section">
                <div class="card-section-title">ğŸƒ ä½¿ç”¨ã‚«ãƒ¼ãƒ‰è¨­å®š</div>
                <div class="card-config" id="cardConfigContainer">
                    <!-- ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
            <button type="submit" class="btn">è¨ˆç®—å®Ÿè¡Œ</button>
        </form>
    </div>

    <div class="card" id="resultCard" style="display: none;">
        <div class="card-header">
            <span>ğŸ“Š</span>
            <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</span>
        </div>
        <div id="resultSummary" style="margin-bottom: 16px; padding: 12px; background: #e7f3ff; border-radius: 6px; color: #004085;"></div>
        <div style="overflow-x: auto;">
            <div id="resultTable"></div>
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #fff8e1;"></div>
                <span>é–‹å§‹æ™‚</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e8f5e9;"></div>
                <span>ãƒãƒ£ã‚¤å¾Œ</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e3f2fd;"></div>
                <span>çµ‚äº†æ™‚</span>
            </div>
            <div class="legend-item">
                <span>âš¡</span>
                <span>ãƒªã‚¹ã‚­ãƒ¼</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ========================================
    // ã‚«ãƒ¼ãƒ‰è¨­å®šï¼ˆâ˜…ã“ã“ã ã‘ç·¨é›†ã™ã‚Œã°OKâ˜…ï¼‰
    // ========================================
    const CARD_CONFIGS = [
        { id: 1, name: 'è¼ã‘ç­‰', defaultUse: true, defaultPlus: 4, defaultPlusTiming: 'current', defaultMinus: 0, defaultMinusTiming: 'current', defaultUsageTiming: 'always' },
        { id: 2, name: 'å›ºæœ‰ç­‰', defaultUse: false, defaultPlus: 0, defaultPlusTiming: 'current', defaultMinus: 0, defaultMinusTiming: 'current', defaultUsageTiming: 'always' },
        { id: 3, name: 'ç©ã¿é‡ã­ç­‰', defaultUse: true, defaultPlus: 2, defaultPlusTiming: 'current', defaultMinus: 0, defaultMinusTiming: 'current', defaultUsageTiming: 'always' },
        // â˜…ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ â˜…
        // { id: 4, name: 'æ–°ã‚«ãƒ¼ãƒ‰', defaultUse: false, defaultPlus: 0, defaultPlusTiming: 'current', defaultMinus: 0, defaultMinusTiming: 'current', defaultUsageTiming: 'always' },
    ];

    // ========================================
    // å®šæ•°
    // ========================================
    const CONSTANTS = {
        TURN_CONSUMPTION: 10,
        RISKY_MULTIPLIER: 1.5,
    };

    // ========================================
    // UIç”Ÿæˆ
    // ========================================
    function generateCardUI() {
        const container = document.getElementById('cardConfigContainer');
        container.innerHTML = '';

        CARD_CONFIGS.forEach(config => {
            const cardHTML = `
                <div class="card-item">
                    <div class="card-item-header">
                        <label>
                            <input type="checkbox" name="card${config.id}Use" ${config.defaultUse ? 'checked' : ''}>
                            <span>ã‚«ãƒ¼ãƒ‰${config.id} (${config.name})</span>
                        </label>
                    </div>
                    <div class="card-detail-grid">
                        <div class="card-detail-row">
                            <span class="card-detail-label">ãƒã‚¤ãƒŠã‚¹å€¤:</span>
                            <input type="number" class="card-detail-input" name="card${config.id}Minus" value="${config.defaultMinus}">
                            <select class="timing-select" name="card${config.id}MinusTiming">
                                <option value="current" ${config.defaultMinusTiming === 'current' ? 'selected' : ''}>ã‚¿ãƒ¼ãƒ³ä¸­</option>
                                <option value="next" ${config.defaultMinusTiming === 'next' ? 'selected' : ''}>æ¬¡ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚</option>
                            </select>
                        </div>
                        <div class="card-detail-row">
                            <span class="card-detail-label">ãƒ—ãƒ©ã‚¹å€¤:</span>
                            <input type="number" class="card-detail-input" name="card${config.id}Plus" value="${config.defaultPlus}">
                            <select class="timing-select" name="card${config.id}PlusTiming">
                                <option value="current" ${config.defaultPlusTiming === 'current' ? 'selected' : ''}>ã‚¿ãƒ¼ãƒ³ä¸­</option>
                                <option value="next" ${config.defaultPlusTiming === 'next' ? 'selected' : ''}>æ¬¡ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚</option>
                            </select>
                        </div>
                    </div>
                    <div class="usage-timing-row">
                        <span style="font-size: 13px; color: #666;">ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°:</span>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="card${config.id}UsageTiming" value="always" ${config.defaultUsageTiming === 'always' ? 'checked' : ''}>
                                æ¯ã‚¿ãƒ¼ãƒ³
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="card${config.id}UsageTiming" value="beforeTrend" ${config.defaultUsageTiming === 'beforeTrend' ? 'checked' : ''}>
                                ãƒˆãƒ¬ãƒªã¾ã§
                            </label>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
        });
    }

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    // ========================================
    class SimulationConfig {
        constructor(formData) {
            this.targetStamina = parseInt(formData.get('targetStamina'));
            this.currentTurn = parseInt(formData.get('currentTurn'));
            this.currentTrendLevel = parseInt(formData.get('currentTrendLevel'));
            this.maxTrendLevel = parseInt(formData.get('maxTrendLevel'));
            this.riskyStartTurn = parseInt(formData.get('riskyStartTurn'));
            this.riskyRemainingTurns = parseInt(formData.get('riskyRemainingTurns'));
            this.hasMotivation = parseInt(formData.get('hasMotivation')) === 1;
            this.chaiCount = parseInt(formData.get('chaiCount'));
            this.trendStartTurn = parseInt(formData.get('trendStartTurn'));
            
            // ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
            this.cards = CARD_CONFIGS.map(config => ({
                use: formData.get(`card${config.id}Use`) === 'on',
                minus: parseInt(formData.get(`card${config.id}Minus`)) || 0,
                minusTiming: formData.get(`card${config.id}MinusTiming`),
                plus: parseInt(formData.get(`card${config.id}Plus`)) || 0,
                plusTiming: formData.get(`card${config.id}PlusTiming`),
                usageTiming: formData.get(`card${config.id}UsageTiming`)
            }));
        }

        validate() {
            const errors = [];
            if (this.currentTurn < 1) errors.push('æ®‹ã‚¿ãƒ¼ãƒ³æ•°ã¯1ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (this.currentTrendLevel > this.maxTrendLevel) errors.push('ç¾åœ¨ã®ãƒˆãƒ¬ãƒªå€¤ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™');
            if (this.trendStartTurn > this.currentTurn) errors.push('ãƒˆãƒ¬ãƒªé–‹å§‹ã‚¿ãƒ¼ãƒ³ãŒç¾åœ¨ã‚¿ãƒ¼ãƒ³ã‚’è¶…ãˆã¦ã„ã¾ã™');
            if (this.riskyStartTurn > this.currentTurn) errors.push('ãƒªã‚¹ã‚­ãƒ¼é–‹å§‹ã‚¿ãƒ¼ãƒ³ãŒç¾åœ¨ã®æ®‹ã‚¿ãƒ¼ãƒ³æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™');
            if (this.riskyRemainingTurns > this.riskyStartTurn) errors.push('ãƒªã‚¹ã‚­ãƒ¼æ®‹ã‚¿ãƒ¼ãƒ³æ•°ãŒé–‹å§‹ã‚¿ãƒ¼ãƒ³ã‚’è¶…ãˆã¦ã„ã¾ã™');
            return errors;
        }
    }

    class TurnState {
        constructor(remaining, isRisky, trend, start, afterChai, end, nextEffect) {
            this.remaining = remaining;
            this.isRisky = isRisky;
            this.trend = trend;
            this.start = Math.floor(start);
            this.afterChai = afterChai !== null ? Math.floor(afterChai) : null;
            this.end = end !== null ? Math.floor(end) : null;
            this.nextEffect = nextEffect;
        }
    }

    class StaminaCalculator {
        constructor(config) {
            this.config = config;
        }

        applyRisky(value, isRisky) {
            return isRisky ? Math.ceil(value * CONSTANTS.RISKY_MULTIPLIER) : value;
        }

        isRiskyTurn(remaining) {
            if (remaining < 1) return false;
            const end = this.config.riskyStartTurn - this.config.riskyRemainingTurns + 1;
            return remaining <= this.config.riskyStartTurn && remaining >= end;
        }

        getTrendConsumption(remaining) {
            if (remaining > this.config.trendStartTurn) return 0;
            const used = this.config.trendStartTurn - remaining;
            return Math.min(this.config.currentTrendLevel + used, this.config.maxTrendLevel);
        }

        getChaiRecovery(isRisky) {
            if (this.config.chaiCount === 0) return 0;
            return this.applyRisky(1, isRisky) * this.config.chaiCount;
        }

        shouldUseCard(card, remaining) {
            if (!card.use) return false;
            const isTrendActive = remaining <= this.config.trendStartTurn;
            return card.usageTiming === 'always' || (card.usageTiming === 'beforeTrend' && !isTrendActive);
        }

        getCurrentTurnCardEffect(remaining, isRisky) {
            let total = 0;
            let activeCards = 0;
            
            if (remaining === this.config.currentTurn && isRisky) {
                console.log(`â˜…[æ®‹${remaining}] ãƒªã‚¹ã‚­ãƒ¼æ™‚ã‚«ãƒ¼ãƒ‰åŠ¹æœè¨ˆç®—:`);
            }
            
            this.config.cards.forEach((card, index) => {
                if (!this.shouldUseCard(card, remaining)) return;
                activeCards++;
                
                if (card.plusTiming === 'current' && card.plus > 0) {
                    const value = this.applyRisky(card.plus, isRisky);
                    total += value;
                    if (remaining === this.config.currentTurn && isRisky) {
                        console.log(`  ã‚«ãƒ¼ãƒ‰${index + 1} +${card.plus} â†’ ${value}`);
                    }
                }
                
                if (card.minusTiming === 'current' && card.minus > 0) {
                    total -= card.minus;  // ãƒªã‚¹ã‚­ãƒ¼é©ç”¨ãªã—
                    if (remaining === this.config.currentTurn && isRisky) {
                        console.log(`  ã‚«ãƒ¼ãƒ‰${index + 1} -${card.minus} â†’ -${card.minus} (ãƒªã‚¹ã‚­ãƒ¼é©ç”¨ãªã—)`);
                    }
                }
            });
            
            if (this.config.hasMotivation && activeCards > 0) {
                const bonusPerCard = this.applyRisky(1, isRisky);
                const totalBonus = bonusPerCard * activeCards;
                total += totalBonus;
                if (remaining === this.config.currentTurn && isRisky) {
                    console.log(`  ãƒ¢ãƒãƒ™: 1Ã—1.5=${bonusPerCard}, ${activeCards}æš â†’ ${totalBonus}`);
                    console.log(`  åˆè¨ˆå›å¾©: ${total}`);
                }
            }
            
            return total;
        }

        getNextTurnEffect(currentRemaining, nextIsRisky) {
            let total = 0;
            
            this.config.cards.forEach(card => {
                if (!this.shouldUseCard(card, currentRemaining)) return;
                
                // ãƒ—ãƒ©ã‚¹å€¤ï¼ˆæ¬¡ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ï¼‰â†’ ãƒªã‚¹ã‚­ãƒ¼é©ç”¨ã‚ã‚Š
                if (card.plusTiming === 'next' && card.plus > 0) {
                    total += this.applyRisky(card.plus, nextIsRisky);
                }
                
                // ãƒã‚¤ãƒŠã‚¹å€¤ï¼ˆæ¬¡ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ï¼‰â†’ ãƒªã‚¹ã‚­ãƒ¼é©ç”¨ãªã—
                if (card.minusTiming === 'next' && card.minus > 0) {
                    total -= card.minus;
                }
            });
            
            return total;
        }

        simulate() {
            const turnStates = [];
            
            for (let remaining = 1; remaining <= this.config.currentTurn; remaining++) {
                const isRisky = this.isRiskyTurn(remaining);
                const trend = this.getTrendConsumption(remaining);
                const chai = this.getChaiRecovery(isRisky);
                const currentCard = this.getCurrentTurnCardEffect(remaining, isRisky);
                
                let prevNextEffect = 0;
                if (remaining > 1) {
                    const prevRemaining = remaining + 1;
                    if (prevRemaining <= this.config.currentTurn) {
                        prevNextEffect = this.getNextTurnEffect(prevRemaining, isRisky);
                        console.log(`[æ®‹${remaining}] å‰T(æ®‹${prevRemaining})ã®æ¬¡TåŠ¹æœ: ${prevNextEffect}`);
                    } else {
                        console.log(`[æ®‹${remaining}] å‰T(æ®‹${prevRemaining})ã¯ç¯„å›²å¤– â†’ æ¬¡TåŠ¹æœ=0`);
                    }
                }
                
                let start, afterChai, end;
                
                if (remaining === 1) {
                    start = this.config.targetStamina;
                    afterChai = null;
                    end = null;
                } else {
                    const prevState = turnStates[turnStates.length - 1];
                    
                    // çµ‚äº†æ™‚ = æ¬¡ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹æ™‚ + 10
                    end = prevState.start + CONSTANTS.TURN_CONSUMPTION;
                    
                    if (remaining === this.config.currentTurn) {
                        console.log(`â˜…[æ®‹${remaining}=ç¾åœ¨T] è©³ç´°:`);
                        console.log(`  çµ‚äº†æ™‚ = ${prevState.start} + 10 = ${end}`);
                        console.log(`  ãƒˆãƒ¬ãƒª: ${trend}`);
                        console.log(`  ã‚«ãƒ¼ãƒ‰åŠ¹æœ: ${currentCard}`);
                        console.log(`  ãƒãƒ£ã‚¤: ${chai}`);
                        console.log(`  å‰Tæ¬¡TåŠ¹æœ: ${prevNextEffect}`);
                    }
                    
                    // é–‹å§‹æ™‚ = çµ‚äº†æ™‚ + æ¶ˆè²»å€¤ - å›å¾©å€¤
                    start = end + trend - currentCard - chai - prevNextEffect;
                    
                    if (remaining === this.config.currentTurn) {
                        console.log(`  é–‹å§‹æ™‚ = ${end} + ${trend} - ${currentCard} - ${chai} - ${prevNextEffect} = ${start}`);
                    }
                    
                    // ãƒãƒ£ã‚¤å¾Œ = é–‹å§‹æ™‚ + ãƒãƒ£ã‚¤ + å‰ã‚¿ãƒ¼ãƒ³ã®æ¬¡ã‚¿ãƒ¼ãƒ³åŠ¹æœ
                    // å‰ã‚¿ãƒ¼ãƒ³ï¼ˆremaining + 1ï¼‰ã®æ¬¡ã‚¿ãƒ¼ãƒ³åŠ¹æœã‚’å–å¾—
                    const prevRemainingForChai = remaining + 1;
                    let prevNextEffectForChai = 0;
                    if (prevRemainingForChai <= this.config.currentTurn) {
                        prevNextEffectForChai = this.getNextTurnEffect(prevRemainingForChai, isRisky);
                    }
                    afterChai = start + chai + prevNextEffectForChai;
                    console.log(`[æ®‹${remaining}] ãƒãƒ£ã‚¤å¾Œ = ${start} + ${chai} + ${prevNextEffectForChai}(å‰Tæ¬¡T) = ${afterChai}`);
                }
                
                const nextIsRisky = this.isRiskyTurn(remaining - 1);
                const nextEffect = this.getNextTurnEffect(remaining, nextIsRisky);
                
                turnStates.push(new TurnState(remaining, isRisky, trend, start, afterChai, end, nextEffect));
            }
            
            return turnStates.reverse();
        }
    }

    class UIController {
        constructor() {
            this.form = document.getElementById('simulatorForm');
            this.errorMessage = document.getElementById('errorMessage');
            this.resultCard = document.getElementById('resultCard');
            this.resultSummary = document.getElementById('resultSummary');
            this.resultTable = document.getElementById('resultTable');
        }

        showError(messages) {
            this.errorMessage.textContent = messages.join('\n');
            this.errorMessage.classList.add('show');
        }

        hideError() {
            this.errorMessage.classList.remove('show');
        }

        renderResults(turnStates, config) {
            const current = turnStates[0];
            
            this.resultSummary.innerHTML = `
                <strong>ğŸ“Œ è¨ˆç®—çµæœ:</strong> 
                ç¾åœ¨ï¼ˆæ®‹${config.currentTurn}ã‚¿ãƒ¼ãƒ³ï¼‰ã®é–‹å§‹æ™‚å…¨åŠ›å€¤ã¯ <strong>${current.start}</strong> å¿…è¦ã§ã™ã€‚
            `;

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ®‹T</th>
                            <th>ãƒªã‚¹</th>
                            <th>ãƒˆãƒ¬ãƒª</th>
                            <th>é–‹å§‹æ™‚</th>
                            <th>ãƒãƒ£ã‚¤å¾Œ</th>
                            <th>çµ‚äº†æ™‚</th>
                            <th>æ¬¡TåŠ¹æœ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            turnStates.forEach(state => {
                const isLow = state.end !== null && state.end < 20;
                const isDanger = state.end !== null && state.end < 0;
                const rowClass = isDanger ? 'danger-row' : (isLow ? 'warning-row' : '');

                html += `
                    <tr class="${rowClass}">
                        <td class="col-turn">${state.remaining}</td>
                        <td class="col-risky">${state.isRisky ? 'âš¡' : ''}</td>
                        <td class="col-trend">${state.trend > 0 ? '-' + state.trend : ''}</td>
                        <td class="col-stamina-start">${state.start}</td>
                        <td class="col-stamina-after-chai">${state.afterChai !== null ? state.afterChai : '-'}</td>
                        <td class="col-stamina-end">${state.end !== null ? state.end : '-'}</td>
                        <td class="col-next-turn-effect">${state.nextEffect !== 0 ? (state.nextEffect > 0 ? '+' : '') + state.nextEffect : '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            this.resultTable.innerHTML = html;
            this.resultCard.style.display = 'block';
        }

        initialize() {
            this.form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleSubmit();
            });
            this.handleSubmit();
        }

        handleSubmit() {
            this.hideError();
            try {
                const formData = new FormData(this.form);
                const config = new SimulationConfig(formData);
                const errors = config.validate();
                if (errors.length > 0) {
                    this.showError(errors);
                    return;
                }
                const calculator = new StaminaCalculator(config);
                const results = calculator.simulate();
                this.renderResults(results, config);
            } catch (error) {
                this.showError(['è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message]);
                console.error(error);
            }
        }
    }

    // ========================================
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        generateCardUI();
        const ui = new UIController();
        ui.initialize();
    });
</script>
```

</body>
</html>
